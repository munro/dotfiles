#!/usr/bin/env nu
# brew autoremove -v && brew cleanup -s --prune=all -v
# TODO curl -fsSL https://claude.ai/install.sh | bash


def main [] {
    cd ~

    let steps = [
        {
            title: "ğŸ¨ Update LS_COLORS"
            desc: "Fetching latest LS_COLORS from trapd00r..."
            cmd: "curl -s https://raw.githubusercontent.com/trapd00r/LS_COLORS/master/lscolors.sh | save -f ~/.ls_colors.sh"
        }
        {
            title: "ğŸ¥Ÿ Upgrade Bun"
            desc: "Installing/upgrading Bun runtime..."
            cmd: "if (which bun | is-empty) { curl -fsSL https://bun.com/install | bash } else { bun upgrade }"
        }
        {
            title: "ğŸ“¡ Updating Homebrew"
            desc: "Fetching latest formulae definitions from GitHub..."
            cmd: "brew update"
        }
        {
            title: "ğŸ“¦ Bundle Sync"
            desc: "Installing from Brewfile, cleaning unlisted, upgrading existing..."
            cmd: "brew bundle --clean --upgrade -v"
        }
        {
            title: "â¬†ï¸  Greedy Upgrade"
            desc: "Upgrading ALL casks including auto-updating ones..."
            cmd: "brew upgrade --greedy -v"
        }
        {
            title: "ğŸ—‘ï¸  Autoremove"
            desc: "Removing orphaned dependencies no longer needed..."
            cmd: "brew autoremove"
        }
        {
            title: "ğŸ§¹ Final Cleanup"
            desc: "Removing orphaned packages not in Brewfile..."
            cmd: "brew bundle cleanup --force"
        }
    ]

    print $"(ansi yellow_bold)ğŸº â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ğŸº(ansi reset)"
    print $"(ansi yellow_bold)   ğŸš€ HOMEBREW UPGRADE EXTRAVAGANZA ğŸš€(ansi reset)"
    print $"(ansi yellow_bold)ğŸº â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ğŸº(ansi reset)\n"

    for $i in 0..<($steps | length) {
        let step = $steps | get $i
        let n = $i + 1
        let total = $steps | length
        let pct = ($n * 100 / $total | into int)
        let filled = ($n * 40 / $total | into int)
        let bar = ("â–ˆ" | fill -c 'â–ˆ' -w $filled) + ("â–‘" | fill -c 'â–‘' -w (40 - $filled))

        print $"\n(ansi cyan)[(ansi reset)(ansi cyan)($bar)(ansi reset)(ansi cyan)](ansi reset) (ansi yellow)($pct)%(ansi reset)"
        print $"(ansi magenta_bold)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”(ansi reset)"
        print $"(ansi green_bold)âœ¨ Step ($n)/($total): ($step.title)(ansi reset)"
        print $"(ansi cyan)   ($step.desc)(ansi reset)"
        print $"(ansi magenta_bold)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”(ansi reset)\n"
        print $"(ansi green)$(ansi reset) ($step.cmd)"
        nu -c $step.cmd
    }

    print $"\n(ansi green_bold)ğŸ‰ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ğŸ‰(ansi reset)"
    print $"(ansi green_bold)   âœ… ALL DONE! Your system is fresh and clean! âœ…(ansi reset)"
    print $"(ansi green_bold)ğŸ‰ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ğŸ‰(ansi reset)\n"
}
