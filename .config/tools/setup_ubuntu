#!/usr/bin/env bash
set -euo pipefail

apt_packages=(
  # Build tooling
  autoconf           # autoconf macros
  automake           # automake
  build-essential    # gcc/g++/make toolchain
  cmake              # cross-platform build system
  pkg-config         # compile/link flags discovery
  libssl-dev         # OpenSSL headers for Rust crates (openssl-sys)

  # Base essentials
  ca-certificates    # TLS root certs
  curl               # HTTP client
  wget               # HTTP client
  git                # version control
  gnupg              # GPG
  jq                 # JSON processor
  openssh-client     # ssh/scp/sftp
  p7zip-full         # 7z
  unzip              # unzip
  xz-utils           # xz compression

  # Shell workflow
  zsh                # shell
  zsh-autosuggestions      # fish-like suggestions
  zsh-syntax-highlighting  # command highlighting
  tmux               # terminal multiplexer
  fzf                # fuzzy finder

  # Modern CLI replacements / utilities
  bat                # cat replacement (binary may be batcat)
  ripgrep            # fast grep
  duf                # disk usage (df replacement)
  htop               # process viewer
  hyperfine          # benchmarking
  procps             # provides watch/ps/top/etc
  pv                 # pipe progress viewer
  pwgen              # password generator
  rsync              # sync/copy tool
  shfmt              # shell formatter

  # Networking
  aria2              # download utility (multi-protocol)
  mosh               # better ssh sessions
  netcat-openbsd     # nc
  nmap               # network scanner

  # Database (local tooling)
  sqlite3            # sqlite CLI
)

sudo apt update
sudo apt install "${apt_packages[@]}"

# ── Node.js LTS (required by coc.nvim) ───────────────────────────────
echo "Installing Node.js 20 LTS..."
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# ── Vim AppImage (latest vim, required for coc.nvim) ─────────────────
echo "Installing latest Vim AppImage..."
vim_appimage_url="$(
  curl -fsSL https://api.github.com/repos/vim/vim-appimage/releases/latest \
    | jq -r '.assets[] | select(.name | test("^Vim-.*x86_64\\.AppImage$")) | .browser_download_url' \
    | head -n 1
)"

if [[ -z "${vim_appimage_url}" || "${vim_appimage_url}" == "null" ]]; then
  echo "ERROR: Could not find latest Vim x86_64 AppImage download URL."
  exit 1
fi

tmp_vim_appimage="$(mktemp)"
curl -fL "${vim_appimage_url}" -o "${tmp_vim_appimage}"
sudo install -m 0755 "${tmp_vim_appimage}" /usr/local/bin/vim
rm -f "${tmp_vim_appimage}"

# ── Rust toolchain ─────────────────────────────────────────────────
if ! command -v rustup &>/dev/null; then
  echo "Installing Rust..."
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
  source "$HOME/.cargo/env"
else
  echo "Updating Rust toolchain..."
  rustup default stable
  rustup update stable
fi

# ── fnm (Fast Node Manager via cargo) ────────────────────────────────
if ! command -v fnm &>/dev/null; then
  echo "Installing fnm via cargo..."
  cargo install fnm
else
  echo "Upgrading fnm..."
  cargo install fnm || true
fi

eval "$(fnm env --shell bash)"
fnm install --lts
fnm default lts-latest

# ── mise (version manager) ────────────────────────────────────────
if ! command -v mise &>/dev/null; then
  echo "Installing mise..."
  curl https://mise.run | sh
else
  echo "mise already installed, updating..."
  mise self-update -y
fi

# ── Cargo packages (install or upgrade) ────────────────────────────
cargo_packages=(
  # Shell essentials (install first — used immediately)
  lsd                # ls replacement with icons/colors

  # Vim
  code-minimap       # minimap.vim backend (binary: code-minimap)

  # Modern CLI replacements / utilities
  du-dust            # du replacement (binary: dust)
  fd-find            # fd replacement (binary: fd)
  git-delta          # pager/diff for git (binary: delta)
  difftastic         # structural/syntax-aware diff (binary: difft)
  sd                 # sed replacement

  # Git utilities
  "lucky_commit --no-default-features"  # lucky hash prefixes (no OpenCL on headless)

  # Cargo tooling
  cargo-update       # `cargo install-update -a` to bulk-update

  # Networking
  trippy             # TUI traceroute/mtr (binary: trip)
)

for entry in "${cargo_packages[@]}"; do
  read -r pkg extra <<< "$entry"
  echo "Installing/upgrading $pkg..."
  cargo install $pkg $extra || true
done

# ── Bun ───────────────────────────────────────────────────────────
if ! command -v bun &>/dev/null; then
  echo "Installing Bun..."
  curl -fsSL https://bun.com/install | bash
else
  echo "Upgrading Bun..."
  bun upgrade
fi

# ── go-task ────────────────────────────────────────────────────────
if ! command -v task &>/dev/null; then
  echo "Installing go-task..."
  sudo sh -c 'curl -1sLf https://dl.cloudsmith.io/public/task/task/setup.deb.sh | bash'
  sudo apt install task
else
  echo "Upgrading go-task..."
  sudo apt install --only-upgrade task || true
fi
