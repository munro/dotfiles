#!/usr/bin/env bash
set -euo pipefail

apt_packages=(
  # Build tooling
  autoconf           # autoconf macros
  automake           # automake
  build-essential    # gcc/g++/make toolchain
  cmake              # cross-platform build system
  pkg-config         # compile/link flags discovery

  # Base essentials
  ca-certificates    # TLS root certs
  curl               # HTTP client
  wget               # HTTP client
  git                # version control
  gnupg              # GPG
  jq                 # JSON processor
  openssh-client     # ssh/scp/sftp
  p7zip-full         # 7z
  unzip              # unzip
  xz-utils           # xz compression

  # Shell workflow
  zsh                # shell
  zsh-autosuggestions      # fish-like suggestions
  zsh-syntax-highlighting  # command highlighting
  tmux               # terminal multiplexer
  fzf                # fuzzy finder

  # Modern CLI replacements / utilities
  bat                # cat replacement (binary may be batcat)
  ripgrep            # fast grep
  duf                # disk usage (df replacement)
  htop               # process viewer
  hyperfine          # benchmarking
  procps             # provides watch/ps/top/etc
  pv                 # pipe progress viewer
  pwgen              # password generator
  rsync              # sync/copy tool
  shfmt              # shell formatter

  # Networking
  aria2              # download utility (multi-protocol)
  mosh               # better ssh sessions
  netcat-openbsd     # nc
  nmap               # network scanner

  # Database (local tooling)
  sqlite3            # sqlite CLI
)

sudo apt update
sudo apt install "${apt_packages[@]}"

# ── Vim AppImage (latest vim, required for coc.nvim) ─────────────────
echo "Installing latest Vim AppImage..."
curl -sL "$(curl -s https://api.github.com/repos/vim/vim-appimage/releases/latest \
  | jq -r '.assets[] | select(.name | test("^Vim-.*x86_64\\.AppImage$")) | .browser_download_url')" \
  -o /usr/local/bin/vim
chmod +x /usr/local/bin/vim

# ── Rust toolchain ─────────────────────────────────────────────────
if ! command -v rustup &>/dev/null; then
  echo "Installing Rust..."
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
  source "$HOME/.cargo/env"
else
  echo "Updating Rust toolchain..."
  rustup default stable
  rustup update stable
fi

# ── mise (version manager) ────────────────────────────────────────
if ! command -v mise &>/dev/null; then
  echo "Installing mise..."
  curl https://mise.run | sh
else
  echo "mise already installed, updating..."
  mise self-update -y
fi

# ── Cargo packages (install or upgrade) ────────────────────────────
cargo_packages=(
  # Shell essentials (install first — used immediately)
  lsd                # ls replacement with icons/colors

  # Vim
  code-minimap       # minimap.vim backend (binary: code-minimap)

  # Modern CLI replacements / utilities
  du-dust            # du replacement (binary: dust)
  fd-find            # fd replacement (binary: fd)
  git-delta          # pager/diff for git (binary: delta)
  difftastic         # structural/syntax-aware diff (binary: difft)
  sd                 # sed replacement

  # Git utilities
  "lucky_commit --no-default-features"  # lucky hash prefixes (no OpenCL on headless)

  # Cargo tooling
  cargo-update       # `cargo install-update -a` to bulk-update

  # Networking
  trippy             # TUI traceroute/mtr (binary: trip)
)

for entry in "${cargo_packages[@]}"; do
  read -r pkg extra <<< "$entry"
  echo "Installing/upgrading $pkg..."
  sudo env CARGO_HOME="$HOME/.cargo" RUSTUP_HOME="$HOME/.rustup" \
    "$HOME/.cargo/bin/cargo" install $pkg $extra --root /usr/local || true
done

# ── go-task ────────────────────────────────────────────────────────
if ! command -v task &>/dev/null; then
  echo "Installing go-task..."
  sudo sh -c 'curl -1sLf https://dl.cloudsmith.io/public/task/task/setup.deb.sh | bash'
  sudo apt install task
else
  echo "go-task already installed"
fi
